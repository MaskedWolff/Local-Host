name: Ultimate Playlist Merge (Fast)

on:
  push:
    paths:
      - My_playlist/**
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download external playlists
        run: |
          echo "Downloading external playlists..."

          curl -fsSL "https://raw.githubusercontent.com/alex8875/m3u/main/jstar.m3u" -o external_jstar.m3u || true
          curl -fsSL "https://raw.githubusercontent.com/drmlive/fancode-live-events/main/fancode.m3u" -o external_fancode.m3u || true
          curl -fsSL "https://raw.githubusercontent.com/alex8875/m3u/main/z5.m3u" -o external_z5.m3u || true
          curl -fsSL "https://raw.githubusercontent.com/drmlive/sliv-live-events/main/sonyliv.m3u" -o external_sonyliv.m3u || true
          curl -fsSL "https://raw.githubusercontent.com/hasanhabibmottakin/Sony-Liv-Channels/main/playlist.m3u" -o external_sonyliv_channels.m3u || true

      - name: Merge playlists
        run: |
          echo '#EXTM3U' > merged_playlist.m3u

          # ðŸ”¥ JSTAR â€“ DROP unwanted + AUTO-DETECT JioStar groups
          if [ -s external_jstar.m3u ]; then
            awk '
              /^#EXTINF:/ {
                # DROP unwanted groups completely
                if ($0 ~ /group-title="Devotional"|group-title="Educational"|group-title="Music"|group-title="Lifestyle"/) {
                  skip = 1
                } else {
                  skip = 0
                }

                if (!skip) {
                  gsub(/group-title="[^"]*"/, "", $0)
                  name = tolower($0)

                  if (name ~ /sports|sport |ten|star sports|espn|cricket|football|league/) {
                    sub(/#EXTINF:/, "#EXTINF:-1 group-title=\"JioStar Sports\" ", $0)
                  }
                  else if (name ~ /movies|movie|cinema|gold|max|pix|hbo|action/) {
                    sub(/#EXTINF:/, "#EXTINF:-1 group-title=\"JioStar Movies\" ", $0)
                  }
                  else if (name ~ /kids|kid|cartoon|disney|nick|pogo|hungama/) {
                    sub(/#EXTINF:/, "#EXTINF:-1 group-title=\"JioStar Kids\" ", $0)
                  }
                  else {
                    sub(/#EXTINF:/, "#EXTINF:-1 group-title=\"JioStar Entertainment\" ", $0)
                  }

                  print
                }
              }
              !/^#EXTM3U/ && !skip
            ' external_jstar.m3u >> merged_playlist.m3u
          fi

          # Other playlists
          for f in \
            external_fancode.m3u \
            external_z5.m3u \
            external_sonyliv.m3u; do

            if [ -s "$f" ]; then
              grep -v '^#EXTM3U' "$f" >> merged_playlist.m3u || true
            fi
          done

          # ðŸ”¥ SonyLIV split
          if [ -s external_sonyliv_channels.m3u ]; then
            awk '
              /^#EXTINF:/ {
                gsub(/group-title="[^"]*"/, "", $0)
                line = tolower($0)

                if (line ~ /sony sports|sports ten|ten 1|ten 2|ten 3|ten 4|ten 5|six/) {
                  sub(/#EXTINF:/, "#EXTINF:-1 group-title=\"Sony Sports\" ", $0)
                } else {
                  sub(/#EXTINF:/, "#EXTINF:-1 group-title=\"SonyLIV Official\" ", $0)
                }
              }
              !/^#EXTM3U/
            ' external_sonyliv_channels.m3u >> merged_playlist.m3u
          fi

          # Local playlists
          if [ -d "My_playlist" ]; then
            find My_playlist -type f -name "*.m3u" -print0 | while IFS= read -r -d '' file; do
              grep -v '^#EXTM3U' "$file" >> merged_playlist.m3u || true
            done
          fi

      - name: Commit if changed
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add merged_playlist.m3u

          if ! git diff --cached --quiet; then
            git commit -m "Auto update merged playlist"
            git push
          else
            echo "No changes"
          fi
