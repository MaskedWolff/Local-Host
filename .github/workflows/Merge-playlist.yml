name: Ultimate Playlist Merge (Fast)

on:
  push:
    paths:
      - My_playlist
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download external playlists
        run: |
          set -e
          echo "Downloading external playlists..."

          curl -fsSL "https://raw.githubusercontent.com/alex8875/m3u/main/jstar.m3u" -o external_jstar.m3u || true
          curl -fsSL "https://raw.githubusercontent.com/drmlive/fancode-live-events/main/fancode.m3u" -o external_fancode.m3u || true
          curl -fsSL "https://raw.githubusercontent.com/alex8875/m3u/main/z5.m3u" -o external_z5.m3u || true
          curl -fsSL "https://raw.githubusercontent.com/hasanhabibmottakin/Sony-Liv-Channels/main/playlist.m3u" -o sony1.m3u || true
          curl -fsSL "https://raw.githubusercontent.com/drmlive/sliv-live-events/main/sonyliv.m3u" -o sony2.m3u || true

      - name: Merge Sony playlists safely
        run: |
          echo "#EXTM3U" > external_sonyliv_merged.m3u
          for f in sony1.m3u sony2.m3u; do
            if [ -s "$f" ]; then
              grep -v '^#EXTM3U' "$f" >> external_sonyliv_merged.m3u
            fi
          done

      - name: Merge all playlists
        run: |
          echo "#EXTM3U" > merged_playlist.m3u

          for f in external_jstar.m3u external_fancode.m3u external_z5.m3u external_sonyliv_merged.m3u My_playlist; do
            if [ -s "$f" ]; then
              grep -v '^#EXTM3U' "$f" >> merged_playlist.m3u
            fi
          done

      - name: Normalize SonyLIV tags
        run: |
          sed -i '/#EXTINF/{
            /SonyLIV\|SONY LIV\|Sony Liv/!b
            /liv1/! s/$/ liv1/
          }' merged_playlist.m3u

      - name: Commit if changed
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add merged_playlist.m3u

          if ! git diff --cached --quiet; then
            git commit -m "Auto update merged playlist"
            git push
          else
            echo "No changes"
          fi
